name: Publish Images

on:
  push:
    branches:
      - master
    tags:
      - "v*"

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io
      OWNER: ${{ github.repository_owner }}
      IMAGE_REPO: mercator-bootstrapper
      FRONTEND_IMAGE_REPO: mercator-frontend-server
      APPHOST: src/Mercator.AppHost/Mercator.AppHost.csproj
      BOOTSTRAPPER_CSPROJ: src/Mercator.Bootstrapper/Mercator.Bootstrapper.csproj
      PUBLISH_OUT: ./artifacts/aspire-publish
      WEB_DIR: src/web

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
          include-prerelease: true

      - name: Install Aspire CLI
        run: dotnet tool install --global Aspire.Cli

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TAGS="sha-${SHORT_SHA}"
          DEPLOY_TAG="sha-${SHORT_SHA}"
          
          # Add latest tag for master branch
          [[ "${{ github.ref }}" == "refs/heads/master" ]] && TAGS="${TAGS},latest"
          
          # Add version tag for version tags (v1.2.3)
          if [[ "${{ github.ref_type }}" == "tag" && "${{ github.ref_name }}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
            TAGS="${TAGS},${VERSION}"
            DEPLOY_TAG="${VERSION}"
          fi
          
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "push_tags=${TAGS}" >> "$GITHUB_OUTPUT"
          echo "deploy_tag=${DEPLOY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push bootstrapper image
        shell: bash
        run: |
          set -euo pipefail
          
          REPO="${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_REPO }}"
          LOCAL_TAG="local-${{ steps.meta.outputs.short_sha }}"
          
          dotnet publish "${{ env.BOOTSTRAPPER_CSPROJ }}" -c Release \
            /t:PublishContainer \
            -p:ContainerRepository="$REPO" \
            -p:ContainerImageTag="$LOCAL_TAG"
          
          IFS=',' read -ra TAGS <<< "${{ steps.meta.outputs.push_tags }}"
          for tag in "${TAGS[@]}"; do
            docker tag "${REPO}:${LOCAL_TAG}" "${REPO}:${tag}"
            docker push "${REPO}:${tag}"
          done

      - name: Generate Aspire manifests
        run: |
          rm -rf "${{ env.PUBLISH_OUT }}"
          aspire publish "${{ env.APPHOST }}" -o "${{ env.PUBLISH_OUT }}"

      - name: Build and push frontend image
        shell: bash
        run: |
          set -euo pipefail
          
          DOCKERFILE=$(find "${{ env.PUBLISH_OUT }}" -name 'frontend-server.Dockerfile' -print -quit)
          [[ -n "$DOCKERFILE" ]] || { echo "❌ frontend-server.Dockerfile not found"; exit 1; }
          
          WEB_IMAGE=$(grep '^ARG WEB_IMAGENAME=' "$DOCKERFILE" | head -n1 | cut -d= -f2- | tr -d '\r')
          [[ -n "$WEB_IMAGE" ]] || { echo "❌ Could not extract WEB_IMAGENAME"; exit 1; }
          
          # Build web stage image inline
          docker build -t "$WEB_IMAGE" "${{ env.WEB_DIR }}" -f - <<'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci
          COPY . .
          RUN npm run build
          EOF
          
          # Build and push frontend-server
          REPO="${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE_REPO }}"
          LOCAL_TAG="local-${{ steps.meta.outputs.short_sha }}"
          
          docker build \
            -f "$DOCKERFILE" \
            --build-arg WEB_IMAGENAME="$WEB_IMAGE" \
            -t "${REPO}:${LOCAL_TAG}" \
            "$(dirname "$DOCKERFILE")"
          
          IFS=',' read -ra TAGS <<< "${{ steps.meta.outputs.push_tags }}"
          for tag in "${TAGS[@]}"; do
            docker tag "${REPO}:${LOCAL_TAG}" "${REPO}:${tag}"
            docker push "${REPO}:${tag}"
          done

      - name: Create and upload deploy info
        shell: bash
        run: |
          mkdir -p ./artifacts
          
          cat > ./artifacts/deploy-info.env <<EOF
          BOOTSTRAPPER_FULL_REPO=${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_REPO }}
          FRONTEND_FULL_REPO=${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE_REPO }}
          DEPLOY_TAG=${{ steps.meta.outputs.deploy_tag }}
          PORT=8080
          EOF

      - name: Upload deploy info
        uses: actions/upload-artifact@v4
        with:
          name: deploy-info
          path: ./artifacts/deploy-info.env
          if-no-files-found: error
