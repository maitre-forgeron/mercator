name: Aspire Compose

on:
  workflow_run:
    workflows: ["Publish Images"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  compose:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
          include-prerelease: true

      - name: Install Aspire CLI
        run: dotnet tool install --global Aspire.Cli

      - name: Generate Docker Compose artifacts
        run: |
          rm -rf ./artifacts/compose
          mkdir -p ./artifacts/compose
          aspire publish src/Mercator.AppHost/Mercator.AppHost.csproj -o ./artifacts/compose

      - name: Download deploy info
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: deploy-info
          path: ./artifacts/deploy-info
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure .env file
        run: |
          set -euo pipefail
          
          # Safely parse the env file (no code execution)
          while IFS='=' read -r key value; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            
            # Remove quotes if present
            value="${value%\"}"
            value="${value#\"}"
            
            # Export to environment
            export "$key=$value"
          done < ./artifacts/deploy-info/deploy-info.env
          
          # Validate required variables
          : "${BOOTSTRAPPER_FULL_REPO:?Missing BOOTSTRAPPER_FULL_REPO}"
          : "${FRONTEND_FULL_REPO:?Missing FRONTEND_FULL_REPO}"
          : "${DEPLOY_TAG:?Missing DEPLOY_TAG}"
          : "${PORT:?Missing PORT}"
          
          # Validate format (prevent injection)
          if [[ ! "$BOOTSTRAPPER_FULL_REPO" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
            echo "Invalid BOOTSTRAPPER_FULL_REPO format"
            exit 1
          fi
          if [[ ! "$FRONTEND_FULL_REPO" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
            echo "Invalid FRONTEND_FULL_REPO format"
            exit 1
          fi
          if [[ ! "$DEPLOY_TAG" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "Invalid DEPLOY_TAG format"
            exit 1
          fi
          if [[ ! "$PORT" =~ ^[0-9]+$ ]]; then
            echo "Invalid PORT format"
            exit 1
          fi
          
          # Update .env file
          cd ./artifacts/compose
          cat >> .env <<EOF
          MERCATOR_BOOTSTRAPPER_IMAGE=${BOOTSTRAPPER_FULL_REPO}:${DEPLOY_TAG}
          FRONTEND_SERVER_IMAGE=${FRONTEND_FULL_REPO}:${DEPLOY_TAG}
          MERCATOR_BOOTSTRAPPER_PORT=${PORT}
          PG_PASSWORD=ci-password
          EOF
          
          echo "Generated .env:"
          cat .env

      - name: Validate docker-compose config
        run: |
          cd ./artifacts/compose
          docker compose --env-file .env config

      - name: Prepare artifacts for upload
        run: cp ./artifacts/compose/.env ./artifacts/compose/env.txt

      - name: Upload compose artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aspire-compose-artifacts
          path: |
            ./artifacts/compose/env.txt
            ./artifacts/compose/docker-compose.yaml
          if-no-files-found: error
