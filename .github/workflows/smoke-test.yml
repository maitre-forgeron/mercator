# smoke-test.yml (fixed)
name: Smoke Test (Compose)

on:
  workflow_run:
    workflows: ["Aspire Compose"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  smoke:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Download compose artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: aspire-compose-artifacts
          path: ./compose
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Locate compose directory
        id: loc
        shell: bash
        run: |
          set -euo pipefail

          echo "Downloaded artifact tree:"
          find ./compose -maxdepth 6 -type f -print

          ENV_FILE="$(find ./compose -type f \( -name "env.txt" -o -name ".env" \) | head -n 1 || true)"
          COMPOSE_FILE="$(find ./compose -type f -name "docker-compose.yaml" | head -n 1 || true)"

          if [ -z "$ENV_FILE" ]; then
            echo "❌ Could not find env.txt or .env in downloaded artifacts"
            exit 1
          fi

          if [ -z "$COMPOSE_FILE" ]; then
            echo "❌ Could not find docker-compose.yaml in downloaded artifacts"
            exit 1
          fi

          COMPOSE_DIR="$(dirname "$COMPOSE_FILE")"
          ENV_BASENAME="$(basename "$ENV_FILE")"
          COMPOSE_BASENAME="$(basename "$COMPOSE_FILE")"

          echo "compose_dir=$COMPOSE_DIR" >> "$GITHUB_OUTPUT"
          echo "env_file=$ENV_BASENAME" >> "$GITHUB_OUTPUT"
          echo "compose_file=$COMPOSE_BASENAME" >> "$GITHUB_OUTPUT"

      - name: Validate compose config
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" config

      - name: Start stack
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" up -d
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" ps

      - name: Smoke test (curl inside compose network)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"

          # Resolve the *container* port (not the host-mapped port) from rendered compose config.
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" config > /tmp/compose.resolved.yaml
          CONTAINER_PORT="$(python3 - <<'PY'
          import sys
          try:
              import yaml
          except Exception:
              print('8080'); sys.exit(0)

          with open('/tmp/compose.resolved.yaml','r',encoding='utf-8') as f:
              data = yaml.safe_load(f)

          svc = (data.get('services') or {}).get('mercator-bootstrapper') or {}
          ports = svc.get('ports') or []

          def extract_container_port(p):
              # "host:container", "ip:host:container", "host:container/tcp", or long syntax dict with target
              if isinstance(p, dict):
                  target = p.get('target')
                  return str(target) if target else None
              if not isinstance(p, str):
                  return None
              last = p.split(':')[-1].split('/')[0].strip()
              return last if last.isdigit() else None

          for p in ports:
              cp = extract_container_port(p)
              if cp:
                  print(cp)
                  sys.exit(0)

          print('8080')
          PY
                    )"

          # Determine compose network name (best-effort). If not found, fallback to "<compose_dir>_aspire".
          NETWORK="$(docker network ls --format '{{.Name}}' | grep -E '(^|_)aspire$' | head -n 1 || true)"
          if [ -z "$NETWORK" ]; then
            PROJECT="$(basename "$(pwd)")"
            NETWORK="${PROJECT}_aspire"
          fi

          echo "Network: $NETWORK"
          echo "Container port: $CONTAINER_PORT"
          echo "Probing (inside network) http://mercator-bootstrapper:${CONTAINER_PORT}/health"

          for i in {1..45}; do
            backend_ok=0
            frontend_ok=0
            proxy_ok=0

            backend_code="$(
              docker run --rm --network "${NETWORK}" curlimages/curl:8.6.0 \
                -sS -o /dev/null -w '%{http_code}' "http://mercator-bootstrapper:${CONTAINER_PORT}/health" \
              || echo 000
            )"
            if [[ "${backend_code}" != "000" ]]; then backend_ok=1; fi

            if docker run --rm --network "${NETWORK}" curlimages/curl:8.6.0 \
                -sS -o /dev/null -w '%{http_code}' "http://frontend-server:5000/" | grep -q '^200$'; then
              frontend_ok=1
            fi

            proxy_code="$(
              docker run --rm --network "${NETWORK}" curlimages/curl:8.6.0 \
                -sS -o /dev/null -w '%{http_code}' "http://frontend-server:5000/api/health" \
              || echo 000
            )"
            if [[ "${proxy_code}" != "000" && "${proxy_code}" != "502" && "${proxy_code}" != "503" ]]; then
              proxy_ok=1
            fi

            echo "Waiting... (${i}/45) backend=${backend_ok}(code=${backend_code}) frontend=${frontend_ok} proxyApi=${proxy_ok}(code=${proxy_code})"

            if [[ "${backend_ok}" == "1" && "${frontend_ok}" == "1" && "${proxy_ok}" == "1" ]]; then
              echo "✅ Smoke test passed"
              exit 0
            fi

            sleep 2
          done

          echo "❌ Smoke test failed (timeout)"
          echo "--- docker compose ps ---"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" ps || true
          echo "--- docker compose logs (last 200 lines) ---"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" logs --no-color --tail=200 || true
          exit 1

      - name: Capture logs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" ps || true
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" logs --no-color --tail=500 || true
