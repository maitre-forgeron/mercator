name: Smoke Test (Compose)

on:
  workflow_run:
    workflows: ["Aspire Compose"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  smoke:
    # Only run when Aspire Compose succeeded AND the originating branch is master
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'master'
    runs-on: ubuntu-latest

    steps:
      - name: Download compose artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: aspire-compose-artifacts
          path: ./compose
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Locate compose directory
        id: loc
        shell: bash
        run: |
          set -euo pipefail

          echo "Downloaded artifact tree:"
          find ./compose -maxdepth 6 -type f -print

          ENV_FILE="$(find ./compose -type f \( -name "env.txt" -o -name ".env" \) | head -n 1 || true)"
          COMPOSE_FILE="$(find ./compose -type f -name "docker-compose.yaml" | head -n 1 || true)"

          if [ -z "$ENV_FILE" ]; then
            echo "❌ Could not find env.txt or .env in downloaded artifacts"
            exit 1
          fi

          if [ -z "$COMPOSE_FILE" ]; then
            echo "❌ Could not find docker-compose.yaml in downloaded artifacts"
            exit 1
          fi

          COMPOSE_DIR="$(dirname "$COMPOSE_FILE")"

          # We will cd into COMPOSE_DIR, so give compose only basenames.
          ENV_BASENAME="$(basename "$ENV_FILE")"
          COMPOSE_BASENAME="$(basename "$COMPOSE_FILE")"

          echo "ENV_FILE=$ENV_FILE"
          echo "COMPOSE_FILE=$COMPOSE_FILE"
          echo "COMPOSE_DIR=$COMPOSE_DIR"
          echo "ENV_BASENAME=$ENV_BASENAME"
          echo "COMPOSE_BASENAME=$COMPOSE_BASENAME"

          echo "compose_dir=$COMPOSE_DIR" >> "$GITHUB_OUTPUT"
          echo "env_file=$ENV_BASENAME" >> "$GITHUB_OUTPUT"
          echo "compose_file=$COMPOSE_BASENAME" >> "$GITHUB_OUTPUT"

      - name: Validate compose config
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" config

      - name: Start stack
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" up -d
          docker compose -f "${{ steps.loc.outputs.compose_file }}" ps

      - name: Smoke test (curl inside compose network)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"

          PORT="$(grep -E '^MERCATOR_BOOTSTRAPPER_PORT=' "${{ steps.loc.outputs.env_file }}" | cut -d= -f2 | tr -d '\r' || true)"
          if [ -z "$PORT" ]; then
            echo "❌ MERCATOR_BOOTSTRAPPER_PORT not set in env file"
            exit 1
          fi

          NETWORK="$(docker network ls --format '{{.Name}}' | grep -E '(^|_)aspire$' | head -n 1 || true)"
          if [ -z "$NETWORK" ]; then
            PROJECT="$(basename "$(pwd)")"
            NETWORK="${PROJECT}_aspire"
          fi

          echo "Network: $NETWORK"
          echo "Port: $PORT"
          echo "Probing http://mercator-bootstrapper:${PORT}/health"

          for i in {1..45}; do
            if docker run --rm --network "$NETWORK" curlimages/curl:8.6.0 \
              -fsS "http://mercator-bootstrapper:${PORT}/health" >/dev/null; then
              echo "✅ Smoke test passed"
              exit 0
            fi

            echo "Waiting for service... ($i/45)"
            sleep 2
          done

          echo "❌ Smoke test failed (timeout)"
          echo "--- docker compose ps ---"
          docker compose -f "${{ steps.loc.outputs.compose_file }}" ps || true
          echo "--- docker compose logs (last 200 lines) ---"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" logs --no-color --tail=200 || true
          exit 1

      - name: Capture logs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" logs --no-color > "${{ github.workspace }}/compose-logs.txt" || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: ./compose-logs.txt
          if-no-files-found: warn

      - name: Tear down
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.loc.outputs.compose_dir }}"
          docker compose --env-file "${{ steps.loc.outputs.env_file }}" -f "${{ steps.loc.outputs.compose_file }}" down -v --remove-orphans || true
